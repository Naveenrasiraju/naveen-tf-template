trigger:
  branches:
    include:
      - test1
    exclude:
      - master
  paths:
    include:
      - module-sources.json

resources:
  pipelines:
  - pipeline: kubeform   # Name of the pipeline resource
    source: kubeform # Name of the pipeline referenced by the pipeline resource
    trigger: 
      branches:
      - releases/*
      - master
  
pool:
  vmImage: "ubuntu-latest"

variables:
  - name: GO111MODULE
    value: on
  - name: CGO_ENABLED
    value: "0"
  - name: GOROOT
    value: "/opt/hostedtoolcache/go/1.14.6/x64"
  - name: GOPRIVATE
    value: "dev.azure.com/sede-ds-adp"
  - group: gogit
  - group: stratos_acr
  - name: REGISTRY
    value: stratosprd.azurecr.io/kubeform

   


steps:
  - checkout: self
  - script: |
      git config --global user.email "sedp-ci@shell.com"
      git config --global user.name "Azure Pipeline"
      git config --global url."https://test:${GIT_READ_TOKEN}@dev.azure.com/sede-ds-adp/Platform%20-%20General/_git/sedp-tf-az-tagging".insteadOf https://sede-ds-adp.visualstudio.com/Platform%20-%20General/_git/sedp-tf-az-tagging
  - script: |
      mv .provider/versions.tf  .

  - task: a4789e5d-f6e8-431f-add9-379d640a883c@0
    inputs:
      terraformVersion: "0.12.26"

  - script: |
      cp .provider/* .
      terraform init
    displayName: Terraform Init

  - script: |
      terraform validate
    displayName: Terraform Validate
  
  - checkout: self
    displayName: Checkout kubeform
    persistCredentials: true
  - checkout: kfc
    displayName: Checkout kfc
    persistCredentials: true
  - script: echo $DOCKER_PASSWORD | docker login stratosprd.azurecr.io  -u $DOCKER_LOGIN --password-stdin
    displayName: Login to Stratos ACR
    env:
      DOCKER_LOGIN: $(DOCKER_LOGIN)
      DOCKER_PASSWORD: $(DOCKER_PASSWORD)
