trigger:
  - test1

pool:
  vmImage: "ubuntu-latest"

variables:
  - name: GO111MODULE
    value: on
  - name: CGO_ENABLED
    value: "0"
  - name: GOROOT
    value: "/opt/hostedtoolcache/go/1.14.6/x64"
  - name: GOPRIVATE
    value: "dev.azure.com/sede-ds-adp"
  - group: gogit
  - group: stratos_acr
  - name: REGISTRY
    value: stratosprd.azurecr.io/kubeform

resources:
  repositories:
    - repository: kubeform
      type: git
      name: Platform - General/kubeform
    - repository: sedp-tf-az-fnapp
      type: git
      name: Platform - General/sedp-tf-az-fnapp

steps:
  - checkout: self
  - script: |
      git config --global user.email "sedp-ci@shell.com"
      git config --global user.name "Azure Pipeline"
      git config --global url."https://test:${GIT_READ_TOKEN}@dev.azure.com/sede-ds-adp/Platform%20-%20General/_git/sedp-tf-az-tagging".insteadOf https://sede-ds-adp.visualstudio.com/Platform%20-%20General/_git/sedp-tf-az-tagging
  - script: |
      cd sedp-tf-az-fnapp
      cp .provider/versions.tf  .

  - task: a4789e5d-f6e8-431f-add9-379d640a883c@0
    inputs:
      terraformVersion: "0.12.26"

  - script: |
      cp .provider/* .
      terraform init
    displayName: Terraform Init

  - script: |
      terraform validate
    displayName: Terraform Validate

  - checkout: kubeform 
    displayName: Checkout kubeform
    persistCredentials: true
  - task: KubectlInstaller@0
    inputs:
      kubectlVersion: "1.18.3"
  - task: GoTool@0
    inputs:
      version: "1.14.6"
  - script: |
      git config --global user.email "sedp-ci@shell.com"
      git config --global user.name "Azure Pipeline"
      git config --global url."https://test:${GIT_READ_TOKEN}@dev.azure.com/sede-ds-adp/Platform%20-%20General/_git/kubeform".insteadOf https://dev.azure.com/sede-ds-adp/kubeform
    displayName: Set git properties
  - script: |
      ls
      sed -i s/0.7.2/0.7.3/g module-sources.json
      git status
      git add -A
      git commit -m "[skip-ci] Update Terraform modules"
      git push origin HEAD:${BUILD_SOURCEBRANCH/#refs\/heads\/}
    displayName: Commit & push results to kubeform
    workingDirectory: kubeform
  - script: git rev-parse HEAD > ../kubeform-sha
    displayName: Store kubeform revision for kfc to use
    workingDirectory: kubeform
  # archive working dir for debugging purposes
  - bash: mkdir -p $(Pipeline.Workspace)/logs
    condition: always()
  - task: ArchiveFiles@2
    condition: always()
    displayName: "Zip workspace"
    inputs:
      rootFolderOrFile: "$(Pipeline.Workspace)/"
      includeRootFolder: false
      archiveType: "zip"
      archiveFile: "$(Pipeline.Workspace)/logs/$(Build.BuildId)-workspace.zip"
  - task: PublishPipelineArtifact@1
    condition: always()
    displayName: "Publish logs"
    inputs:
      artifact: "logs"
      targetPath: $(Pipeline.Workspace)/logs
